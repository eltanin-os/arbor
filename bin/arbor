#!/bin/execlineb
elgetopt "ac:bo:p"
multisubstitute {
	importas -D "0" ELGETOPT_a ELGETOPT_a
	importas -D "../../cache" ELGETOPT_c ELGETOPT_c
	importas -D "0" ELGETOPT_b ELGETOPT_b
	importas -D "" ELGETOPT_o ELGETOPT_o
	importas -D "0" ELGETOPT_p ELGETOPT_p
	importas -i ARBOR ARBOR
	importas -i PATH PATH
}
elgetpositionals
emptyenv -Po
backtick ARBOR_HOSTARCH { uname -m }
backtick ARBOR_HOSTOS { pipeline { uname -s } awk "{print tolower($0)}" }
export PATH "${ARBOR}/bin:${PATH}"
cd $ARBOR
envfile "config/defaults"
# set sandbox mode
importas -iu ARBOR_SANDBOX ARBOR_SANDBOX
backtick ARBOR_SANDBOX {
	ifelse -n { test "${ELGETOPT_b}" -eq "0" } {
		echo "pseudosandbox"
	}
	echo "${ARBOR_SANDBOX}"
}
export ARBOR_BOOTSTRAPMODE "${ELGETOPT_b}"
# getopts
ifelse -n { test "${ELGETOPT_a}" -eq "0" } {
	redo all
}
ifelse -n { test -z "${ELGETOPT_o}" } {
	elglob repositories "./repo/*"
	if { mkdir -p $ELGETOPT_o }
	cd $ELGETOPT_o
	forx -E repo { $repositories }
	backtick -Ex name { basename $repo }
	define PKGDIR "${ARBOR}/populate/${name}"
	if -t { test -f "${PKGDIR}/chksum" }
	if {
		if {
			redirfd -a 1 chksum
			cat ${PKGDIR}/chksum
		}
		arbor-priv-pkgexplode ${PKGDIR}/database
	}
	if { mkdir -p $ELGETOPT_c }
	cd $ELGETOPT_c
	find ${PKGDIR} -name "*.pkg" -exec
	    define pkg "{}"
	    backtick -Ex file { basename $pkg }
	    backtick -Ex chksum { venus-conf ${file} ${PKGDIR}/chksum }
	    cp $pkg ./${chksum}.${file}
	    ;
}
ifelse -n { test "${ELGETOPT_p}" -eq "0" } {
	redo populate/all
}
forx -Eo 0 package { $@ }
backtick path {
	export ARBOR_PACKAGENAME ""
	arbor-priv-printpkgdep $package
}
importas -iu path path
redo $path
