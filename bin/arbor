#!/bin/execlineb
elgetopt "ac:bo:p"
multisubstitute {
	importas -uD "0" ELGETOPT_a ELGETOPT_a
	importas -uD "../../cache" ELGETOPT_c ELGETOPT_c
	importas -uD "0" ELGETOPT_b ELGETOPT_b
	importas -uD "0" ELGETOPT_o ELGETOPT_o
	importas -uD "0" ELGETOPT_p ELGETOPT_p
	importas -i ARBOR ARBOR
	importas -i PATH PATH
}
elgetpositionals
emptyenv -Po
backtick ARBOR_HOSTARCH { uname -m }
backtick ARBOR_HOSTOS { pipeline { uname -s } awk "{print tolower($0)}" }
export ARBOR_BOOTSTRAPMODE "${ELGETOPT_b}"
export PATH "${ARBOR}/bin:${PATH}"
cd $ARBOR
envfile "config/defaults"
ifelse -Xn { test "${ELGETOPT_a}" -eq "0" } {
	redo all
}
ifelse -Xn { test "${ELGETOPT_o}" -eq "0" } {
	if { test -d "${ELGETOPT_o}" }
	elglob repositories "./repo/*"
	cd $ELGETOPT_o
	forx -E repo { $repositories }
	backtick -Ex name { basename $repo }
	define PKGDIR "${ARBOR}/populate/${name}"
	if -t { test -d "${PKGDIR}" }
	if {
		if { cp ${PKGDIR}/chksum . }
		arbor-priv-pkgexplode ${PKGDIR}/database
	}
	cd $ELGETOPT_c
	find ${PKGDIR} -name "*.pkg" -exec
	    define pkg "{}"
	    backtick -Ex chksum {
	    	backtick -Ex file { basename $pkg }
	    	venus-conf ${file} ${PKGDIR}/chksum
	    }
	    cp $pkg ./${chksum}.${pkg}
	    ;
}
ifelse -Xn { test "${ELGETOPT_p}" -eq "0" } {
	redo populate/all
}
forx -Eo 0 package { $@ }
backtick path {
	export ARBOR_PACKAGENAME ""
	arbor-priv-printpkgdep $package
}
importas -iu path path
redo-ifchange $path
