#!/bin/execlineb -P
if { ln -s bin sbin }
if { ln -s . usr }
if { mkdir -p etc }
if { touch etc/passwd etc/group }
importas -i ARBOR ARBOR
if {
	if { mkdir -p bin }
	elglob arbin "${ARBOR}/bin/*"
	cp $arbin bin
}
importas -i ARBOR_PACKAGEDIR ARBOR_PACKAGEDIR
if {
	importas -i ARBOR_PACKAGESRC ARBOR_PACKAGESRC
	cd tmp/${ARBOR_PACKAGESRC}
	arbor-priv-patch $ARBOR_PACKAGEDIR
}
if {
	if -t { test -d ${ARBOR_PACKAGEDIR}/files }
	cp -R ${ARBOR_PACKAGEDIR}/files tmp
}
importas -i ARBOR_SANDBOX ARBOR_SANDBOX
if {
	if { mkdir -p etc/arbor }
	backtick repoconf {
		awk
"
BEGIN {
	path=\"${ARBOR_PACKAGEDIR}\"
	n=1
	while (1) {
		sub(/\\/[A-Za-z0-9_]*$/, \"\", path)
		if (path == \"${ARBOR}/repo\") {
			break
		}
		tab[n++] = path \"/repo.conf\"
	}
	for (n = n - 1; n; n--) print tab[n]
}
"
	}
	importas -isu repoconf repoconf
	arbor-priv-createconfigfile
	    etc/arbor/config
	    ${ARBOR}/config/defaults
	    ${ARBOR}/config/${ARBOR_SANDBOX}
	    $repconf
}
if { cp ${ARBOR_PACKAGEDIR}/build tmp/build.arbor }
arbor-priv-create$ARBOR_SANDBOX tmp/build
