#!/bin/execlineb -S1
backtick files { mktemp }
backtick devfiles { mktemp }
backtick dynfiles { mktemp }
backtick tmpdir { arbor-priv-mktempdir }
multisubstitute {
	importas -iu files files
	importas -iu devfiles devfiles
	importas -iu dynfiles dynfiles
	importas -iu tmpdir tmpdir
}
foreground {
	getcwd -E pwd
	cd $tmpdir
	if { arbor-priv-pkgexplode $1 }
	if {
		importas -i LIBDIR LIBDIR
		if -t { test -d "./${LIBDIR}" }
		if {
			redirfd -a 1 $dynfiles
			find ./${LIBDIR} -name "*.so*" ! -type d
		}
		redirfd -a 1 $devfiles
		find ./${LIBDIR} ! -name "*.so*" ! -type d
	}
	if {
		importas -i INCDIR INCDIR
		if -t { test -d "./${INCDIR}" }
		redirfd -a 1 $devfiles
		find ./${INCDIR} ! -type d
	}
	if {
		importas -i DRTDIR DRTDIR
		redirfd -a 1 $devfiles
		if {
			if -t { test -d "./${DRTDIR}/aclocal" }
			find ./${DRTDIR}/aclocal ! -type d
		}
		if {
			if -t { test -d "./${DRTDIR}/pkgconfig" }
			find ./${DRTDIR}/pkgconfig ! -type d
		}
		if -t { test -d "./${DRTDIR}/xcb" }
		find ./${DRTDIR}/xcb ! -type d
	}
	if {
		importas -i MANDIR MANDIR
		if -t { test -d "./${MANDIR}" }
		redirfd -a 1 $devfiles
		find ./${MANDIR} \( -name "*.2" -o -name "*.3" \) ! -type d
	}
	multisubstitute {
		importas -is DEFLATE DEFLATE
		importas -is ARCHIVE ARCHIVE
		importas -i name name
		importas -i version version
	}
	if {
		if -t { test -s "${devfiles}" }
		if {
			pipeline {
				redirfd -r 0 $devfiles
				$ARCHIVE
			}
			redirfd -w 1 ${pwd}/${name}-dev#${version}.pkg
			$DEFLATE
		}
		if {
			if { echo "${name}-dev" }
			redirfd -r 0 $devfiles
			xargs rm -f
		}
		rm $devfiles
	}
	if {
		if -t { test -s "${dynfiles}" }
		if {
			pipeline {
				redirfd -r 0 $dynfiles
				$ARCHIVE
			}
			redirfd -w 1 ${pwd}/${name}-dyn#${version}.pkg
			$DEFLATE
		}
		if {
			if { echo "${name}-dyn" }
			redirfd -r 0 $dynfiles
			xargs rm -f
		}
		rm $dynfiles
	}
	if {
		if {
			redirfd -w 1 $files
			find . ! -type d
		}
		if -t { test -s "${files}" }
		if {
			pipeline {
				redirfd -r 0 ${files}
				$ARCHIVE
			}
			redirfd -w 1 ${pwd}/${name}#${version}.pkg
			$DEFLATE
		}
		rm $files
	}
	if -t { test -e "${pwd}/${name}#${version}.pkg" }
	echo "${name}"
}
importas -iu status ?
foreground { rm -f $files $devfiles $dynfiles }
foreground { arbor-priv-freetempdir $tmpdir }
exit $status
